# eBPF for Windows Azure VM Extension for IaaS

>Ref. docs: https://github.com/Azure/azure-vmextension-publishing/wiki

This project implements the eBPF for Windows Azure VM Extension for IaaS. This extension allows you to deploy eBPF programs to Azure VMs running Windows.
The extension also relies on the Azure VM Agent to execute a number of Powershell scripts to install the eBPF runtime and default eBPF programs.

The minimal requirements for a VM Extension are:

- Provide `HandlerManifest.json` file, must be located in the package's root folder. It defines how the VM Extension Handler functionalities are performed.
- Process the `HandlerEnvironment.json` file, provided at runtime by the VM-Agent and always located in the package's root folder. It defines the environment variables that are passed to the VM Extension Handler from the VM Agent. This file is generated by the VM Agent, it is not meant to be modified by the user.
- Generate status files: all operations that need to create a "status file", will generate create a `<SequenceNumber>.status` file under the given "`statusFolder`" folder from the "`HandlerEnvironment.json`". The *SequenceNumber* is determined from the `ConfigSequenceNumber` environment variable, available at the *Process* level.
- Scripts or executables for installing, enabling, disabling uninstalling, and updating the VM Extension. These scripts or executables are defined in the `HandlerManifest.json` file, and are called by the VM Agent with the appropriate command, as defined in the `HandlerEnvironment.json` file.

## VM Extension Handler implementation

The eBPF VM Extension Handler functionalities are implemented through PowerShell 6.0+ scripts, given that PowerShell and the default .NET 4.7.2 runtime (which Powershell 6.0+ is built on top of) are present in WS2019 & WS2022, as documented here:

- [PowerShell Support Lifecycle](https://learn.microsoft.com/en-us/powershell/scripting/install/powershell-support-lifecycle?view=powershell-7.3#release-history)
- [.NET Framework versions and dependencies](https://learn.microsoft.com/en-us/dotnet/framework/migration-guide/versions-and-dependencies#net-framework-472)

All Handler commands relay on a single `common.ps1` script library, while keeping all the command scripts such enable/disable/install/update as one-liners, for better readability and maintainability.

### Versioning
>Ref. docs: https://github.com/Azure/azure-vmextension-publishing/wiki/Extension-Handler-Publishing#about-extension-versioning

The VM Extension is versioned using the following format, `<MajorVersion.MinorVersion.PatchVersion.HotfixVersion>`, which nicely overlaps with the `<Major.Minor.Patch>` [Semantic Versioning](https://semver.org/) specification used in eBPF For Windows. We therefore leverage the last fourth digit for the VM Extension Handler updating only, so that it will be possible to update the handler itself, while maintaining the same eBPF version.

>**IMPORTANT**: the VM Extension platform only supports 2 digits for the version number, when installed from the client, so in practice, it will not be possible to control the deployment of the eBPF bits down to the *Patch* level, i.e., the VM-Agent will always pick the latest version of the VM Extension Handler for a given *<Major.Minor>* version, and will not be able to pick a specific "*<\*.\*.PatchVersion.HotfixVersion>*" version. This is a by-design constraint of the VM Extension platform, and it is not expected to be changed in the near future.

### Handler logic
>Ref. docs: https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#236-summary

The VM Agent will call the VM Extension Handler's commands, whenever the VM Extension is enabled, disabled, reset, installed, updated, or uninstalled. From a theoretical point, it's worth noting that these commands are always pertaining to the VM Extension itself, and not to the eBPF runtime or eBPF programs that are installed by the VM Extension. We though use these commands to install, update, and uninstall the eBPF runtime and eBPF programs, conditionally to the logical connections between the VM Extension and the eBPF runtime and eBPF programs.

#### VM Extension Handler commands

- **Install command**: This operation will install the eBPF runtime and eBPF programs, and will NOT create a `.status` file, since the VM Agent will subsequently call the Handler with the `Enable` command.
The install command is actually implemented by the `Install-eBPF-Handler` function, which will install the eBPF runtime and eBPF programs, if not already installed, or update them, if already installed.. If for any reason eBPF is installed in a different location from the default, it will maintain the same location, and will update the eBPF runtime and eBPF programs in that location.

    - Return codes - 0: success, Non-0: failure.
    - Writes status file: **No**.

- **Update command**: The update command is actually implemented by the `Update-eBPF-Handler` function (see *"Update operation"* sequence below).

    - Return codes - 0: success, Non-0: failure.
    - Writes status file: **No**.

- **Uninstall command**: This operation will uninstall the eBPF runtime and eBPF programs, and will create a `.status` file, and is actually implemented by the `Update-eBPF-Handler` function.

    - Return codes - 0: success, Non-0: failure.
    - Writes status file: **No**.

- **Enable command**: This operation will **start** the eBPF services, and create a `.status` file, and is actually implemented by the `Enable-eBPF-Handler` function.

    - Return codes - 0: success, Non-0: failure.
    - Writes status file: **Yes**

- **Disable command**: This operation will **stop** the eBPF services, and create a `.status` file, and is actually implemented by the `Disable-eBPF-Handler` function.

    - Return codes - 0: success, Non-0: failure.
    - Writes status file: **No**

- **Reset**: Currently, no action is performed.

    - Return codes - 0: success.
    - Writes status file: **No**

#### VM Agent lifecycle operations
>Ref. docs: https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#22-handler-lifecycle-management 

>Note: see Feature request: https://msazure.visualstudio.com/One/_workitems/edit/25279093

Given the by-design command-sequence invoked by the VM Agent in the 3 main scenarios, the VM Extension Handler will perform the following actions for each command, in order to achieve the best performance:

- **Install operation**:
    1. Calls the handler's *install command* -> install/update eBPF.
    1. Calls the handler's *enable command* -> start eBPF drivers, restart the GuestProxyAgent service.

- **Update operation**:
    1. Calls the handler's *disable command* (on the old handler) -> stop eBPF drivers.
    1. Calls the handler's *update command* (on the new handler) -> NOP.
    1. Calls the handler's *uninstall command* (on the old handler) -> uninstall eBPF.
    1. Calls the handler's *install command* (on the new handler) -> install/update eBPF.
    1. Calls the handler's *enable command* (on the new handler) -> start eBPF drivers, restart the GuestProxyAgent service.

- **Uninstall operation**:
    1. Calls the handler's *disable command* -> stop eBPF drivers.
    1. Calls the handler's *uninstall command* -> uninstall eBPF.

- **Enable operation**, **Disable operation** and **Reset operation** simply call the corresponding handler command.

>**NOTE**: the *enable command* will start the eBPF drivers, and upon success, it will also attempt to restart the GuestProxyAgent service.
> Although restarting the GuestProxyAgent service is an extended operation that is not part of the eBPF VM Extension's scope, we account success/failure of this operation in the overall update status, so that the VM Agent will stop rolling out updates.
>
>By design, if the GuestProxyAgent fails to restart, eBPF will *not* be uninstalled, as upon this failure, the VM Agent will rollback by calling the *Update operation* on the old handler, thus, downgrading eBPF to the previous version.

## Releasing the eBPF VM Extension Handler

>Ref. docs: https://github.com/Azure/azure-vmextension-publishing/wiki/Extension-Handler-Publishing

### Prerequisites

- Ask to be "`Azure Service Deploy Release Management Contributor`" of the Team's Azure Prod subscription, currently "`eBPF for Windows`", SubscriptionID: `78a9bec8-945c-4cc0-83bf-77c6d384d2ca`.
- Create a resource group named "`EbpfVmExtension`" in the Azure Prod subscription.
- Create as Azure Storage Account account in the Azure Prod subscription, named "`ebpfstorageaccount`", within the "`EbpfVmExtension`" resource group.
- Create an Azure Blob Container named "`ebpf-ext-container`" within the "`ebpfstorageaccount`" Storage Account.

### Creating the VM Extension Handler Package

>IMPORTANT: ensure that all the VM Extension Handler's PowerShell scripts in the "`\scripts`" folder, are code-signed before zipping the package. The signing can be done through the [ESRP portal](https://portal.esrp.microsoft.com/), using the "`Legacy COPS 400`" certificate (aka `CP-230012`), which is recommended [here - "Parameters for signing task"](https://eng.ms/docs/cloud-ai-platform/azure-edge-platform-aep/aep-engineering-systems/productivity-and-experiences/onebranch-platform-services/onebranch/signing/containerbuildsigning).

1. Once you have the eBPF redistributable package to be released from the CI/CD pipeline, create the VM Extension ZIP file by executing the following PowerShell script from the `.azure` folder:

    ```PS
    PS> .\create-zip-package.ps1 -versionNumber <x.y.z.p> -ebpfBinPackagePath "<full path to the eBPF binaries root from the eBPF Redist package>" -zipDestinationFolder "<full path to the destination folder for the ZIP package file>"

    # Example: creating the package for eBPF v0.9.1, with the extension handler patch v1 for that eBPF version -> v0.9.1.1
    PS> .\create-zip-package.ps1 -versionNumber "0.9.1.1" -ebpfBinPackagePath "D:\work\_scratch\v0.9.1" -zipDestinationFolder "D:\work\_scratch"

    ```
    The resulting ZIP file will be named after the following format:
    
    ```bash
    <publisher>.<extension name>.<version>.zip # e.g.: Microsoft.EbpfForWindows.EbpfForWindows.0.9.1.1.zip
    ```

    where:

    - `<publisher>` is the publisher name, i.e. `Microsoft.EbpfForWindows`.
    - `<extension name>` is the extension name, i.e. `EbpfForWindows`.
    - `<version>` is the VM Extension version, conventionally matching its first 3 digits with the eBPF version, e.g. `0.9.1.1` (`<MajorVersion.MinorVersion.PatchVersion.HotfixVersion>`, which we overlap with the `<Major.Minor.Patch>` versioning for eBPF).

1. Upload the zip file to the Azure Storage Account container named "`ebpf-vm-extension-artifacts`" within the "`eBPF-vm-extension`" resource group (see [Prerequisites](#Prerequisites)).

### Registering the VM Extension

Registering the VM Extension is a **one-time operation**, since this will simply register the VM Extension's namespace and metadata to the platform, with no information regarding versioning or media.

From your SAW Machine, register the [*`.azure\eBpfArmRegistrationTemplate.json`*](./src/.azure/eBpfArmRegistrationTemplate.json) ARM template using the following PowerShell commands:

```PS
# Make sure you install the latest Az PowerShell v6 (only needed once)
Install-Module az 

# Ensure you are logged in with the correct subscription
Connect-AzAccount
Select-AzSubscription -SubscriptionId 78a9bec8-945c-4cc0-83bf-77c6d384d2ca

# CD to the path where a local copy of the publishing ARM template is located, and register the VM Extension within the created resource group, using the following commands:
$resourceGroupName = "EbpfVmExtension"
New-AzResourceGroupDeployment -Name ExtensionPublishing -ResourceGroupName $resourceGroupName -TemplateFile .\eBpfArmRegistrationTemplate.json -Verbose
```

### Publishing the VM Extension

Make sure to update the following variables in the [*`.azure\eBpfArmPublishingTemplate.json`*](./src/.azure/eBpfArmPublishingTemplate.json) ARM template, with all the required information for the current version of the VM Extension, e.g.:

```json
"version": "0.9.1.1", // The version of the VM Extension
"mediaLink": "https://ebpfextstorageaccount.blob.core.windows.net/ebpf-ext-container/Microsoft.EbpfForWindows.EbpfForWindows.0.9.1.1.zip", // The URL of the ZIP file containing the VM Extension Handler
"regions": ["East US 2 EUAP", ...], // List of regions in which the extension will be published
"isInternalExtension": "true/fase", // Whether the extension is internal or not. IMPORTANT!! This flag cannot be reverted once the extension has been made public!
``` 
> NOTE: Canary regions can be either "`East US 2 EUAP`" or "`Central US EUAP`".

From your SAW Machine, publish the *`eBpfArmPublishingTemplate.json`* ARM template using the using the following PowerShell commands:
    
```PS
# Ensure you are logged in with the correct subscription
Connect-AzAccount
Select-AzSubscription -SubscriptionId 78a9bec8-945c-4cc0-83bf-77c6d384d2ca

# CD to the path where a local copy of the publishing ARM template is located, and publish the VM Extension within the created resource group, using the following commands:
$resourceGroupName = "EbpfVmExtension"
New-AzResourceGroupDeployment -Name ExtensionPublishing -ResourceGroupName $resourceGroupName -TemplateFile .\eBpfArmPublishingTemplate.json -Verbose
```

#### Verifying the Publishing status

When the extension is getting published, it can sometimes take a few hours in certain regions. Until the extension is replicated in all regions it will not be listed.

You can check/verify the regional status by using the following PowerShell commands. These commands must be executed **within the context of the publisher's subscription** (i.e. on the SAW machine):

```PS
$publisherName="Microsoft.EbpfForWindows"
$typeName="EbpfForWindows"
$version="0.9.1.1"
$resourceGroupName = "EbpfVmExtension"
$name = $publisherName + "." + $typeName + "/" + $version
(Get-AzResource -ResourceGroupName $resourceGroupName -Name $name -ExpandProperties).Properties.replicationStatus.summary | Sort-Object -Property "region" | Format-Table
```

>**NOTE**: once the publishing has succeeded, the blob on the storage account can be safely deleted, so that it will not be publicly accessible anymore. Another approach could be to just remove public access to the blob, so that it will not be publicly accessible anymore, which would allow keeping a history of published ZIP files.

## Testing the eBPF VM Extension Handler

### Prerequisites

Request to be "`owner`" of the Team's Azure Prod subscription, currently "`eBPF for Windows`", SubscriptionID: "`78a9bec8-945c-4cc0-83bf-77c6d384d2ca`".

### Create a Test-VM

Follow the steps below to create a Test-VM for testing the eBPF VM Extension:

- The Test-VM for testing the VM Extension Handler must be created **from within the Team's Azure Production subscription**. 
- Create the Test-VM within the same resource group named "`EbpfVmExtension`", in which the storage account was created earlier.
- The Test-VM **must** be created within the ***same region in which the VM Extension has been registered an published***, otherwise the VM Extension will not be found.
- Due to the Production subscription's limitations, creating a VM from the Azure portal is denied, so it must be created it from PowerShell:

    ```PS
    # Ensure you are logged in with the correct subscription
    Connect-AzAccount
    Select-AzSubscription -SubscriptionId 78a9bec8-945c-4cc0-83bf-77c6d384d2ca

    # Setting up the environment variables, for a "WS2019 Datacenter Gen2" VM type
    $credential = Get-Credential
    $resourceGroupName = 'EbpfVmExtension'
    $location = 'eastus2euap'
    $vmName = 'EbpfVm-EastEUAP'
    $vmSize = 'Standard_B2als_v2'
    $image = 'MicrosoftWindowsServer:WindowsServer:2019-datacenter-gensecond:latest'

    New-AzVM -Name $vmName -Credential $credential -ResourceGroupName $resourceGroupName -Location $location -Size $vmSize -Image $image
    ```

### Installing the eBPF VM Extension on the Test-VM

>Ref. docs: https://learn.microsoft.com/en-us/powershell/module/az.compute/set-azvmextension?view=azps-10.3.0

```PS
# Ensure you are logged in with the correct subscription
Connect-AzAccount
Select-AzSubscription -SubscriptionId 78a9bec8-945c-4cc0-83bf-77c6d384d2ca

# Below are the eBPF VM Extension parameters
$publisherName="Microsoft.EbpfForWindows"
$typeName="EbpfForWindows"
$version="0.9" # NOTE: the VM Extension platform only supports 2 digits for the version number, when installed from the client, so we need to truncate the eBPF version number to 2 digits!

# Below are the Test-VM parameters
$vmExtName = "EbpfForWindows" # NOTE: this is the desired name for the extension on the Test-VM, not the VM Extension name!
$vmResourceGroup = "EbpfVmExtension"
$vmLocation = "eastus2euap"
$vmName = "EbpfVm-EastEUAP"
$extSettings = @{"temp" = "";}; # NOTE! A dummy settings file is necessary for the VM Extension handler to retrieve a 'SequenceNumber' and generate status files, even if the VM Extension does not support user-settings! This is "by design".

Set-AzVMExtension -Publisher $publisherName -ExtensionType $typeName -Name $vmExtName -TypeHandlerVersion $version -Location $vmLocation -ResourceGroupName $vmResourceGroup -VMName $vmName -Settings $extSettings
```

The logs from the VM-Agent will be located under `C:\WindowsAzure\Plugins\<full VM Extension namespace>\<version>\`:

- "`CommandExecution.log`": contains the logs from the "`Windows Azure Guest Agent`" Windows service, whish handles all VM Extension Handlers command execution.
- "`ebpf_handler.log`": contains the logs of the eBPF VM Extension Handler execution.


### Removing the eBPF VM Extension from the Test-VM

>Ref. docs: https://learn.microsoft.com/en-us/powershell/module/az.compute/remove-azvmextension?view=azps-10.3.0

```PS
$vmExtName = "EbpfForWindows" # NOTE: this is the given name of the extension on the Test-VM, not the VM Extension name!
$vmResourceGroup = "EbpfVmExtension"
$vmName = "EbpfVm-EastEUAP"
Remove-AzVMExtension -ResourceGroupName $vmResourceGroup -Name $vmExtName -VMName $vmName
```

## Appendix
### Undefined topics in the official docs

#### 1.0 Partner Guide Overview
[1.3 AggregateStatus Architecture Overview](https://github.com/Azure/azure-vmextension-publishing/wiki/1.0-Partner-Guide-Overview#13aggregatestatus-architecture-overview): `images/extensionarchitecture.png` link is broken.

#### 2.3.4 Update Command (empty - WIP)
https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#234-update-command

For example, does the `Update` call `Enable`, like the `Install`? Looks not clarified also in [2.2.3 Update a handler to different version](https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#223update-a-handler-to-different-version)

#### 2.3.6 Summary
https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#236-summary

- The "Reserved Exit Code" & "Recommended Exit Code" paragraphs are WIP -> is the publisher free to use any?
- In the "`VM Agent Contracts Expectations for Handler Commands Window VM"`, the `Disable` & `Reset` commands have a `"Yes?"`, which does not uniquely define the column "Extension writes status file".
    > NOTE: A follow up with the VM Extension Team confirmed **No**.
- The `Uninstall` handler command has conflicting information in the [2.3.6 Summary](https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#236-summary):
    - In the "`VM Agent Contracts Expectations for Handler Commands Window VM`" table, the `Uninstall` command has a `"Yes"` in the column "Extension writes status file".
    - In the "`ConfigSequenceNumber`" environment variable table, the `Uninstall` command is not present, therefore indicating that it could not write a status file.
    > NOTE: A follow up with the VM Extension Team confirmed that `Uninstall` should **Not** write a status file.
- Although the [2.2.1 Add a new handler on the VM (Install and Enable)](https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#221-add-a-new-handler-on-the-vm-install-and-enable) specifies that the `Enable` command will be called and required to generate a Status file, in the summary it is defined as "NA", and [here](https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#231-install-command) is undocumented.
