# eBPF for Windows Azure VM Extension for IaaS

Ref. docs: https://github.com/Azure/azure-vmextension-publishing/wiki

This project implements the eBPF for Windows Azure VM Extension for IaaS. This extension allows you to deploy eBPF programs to Azure VMs running Windows.
The extension also relies on the Azure VM Agent to execute a number of Powershell scripts to install the eBPF runtime and default eBPF programs.

The minimal requirements for a VM Extension are:

- Provide `HandlerManifest.json` file, must be located in the package's root folder. It defines how the VM Extension Handler functionalities are performed.
- Process the `HandlerEnvironment.json` file, provided at runtime by the VM-Agent and always located in the package's root folder. It defines the environment variables that are passed to the VM Extension Handler from the VM Agent. This file is generated by the VM Agent, it is not meant to be modified by the user.
- Generate status files: all operations that need to create a "status file", will generate create a `<SequenceNumber>.status` file under the given "`statusFolder`" folder from the "`HandlerEnvironment.json`". The *SequenceNumber* is determined from the `ConfigSequenceNumber` environment variable, available at the *Process* level.
- Scripts or executables for installing, enabling, disabling uninstalling, and updating the VM Extension. These scripts or executables are defined in the `HandlerManifest.json` file, and are called by the VM Agent with the appropriate command, as defined in the `HandlerEnvironment.json` file.

## VM Extension Handler implementation

The eBPF VM Extension Handler functionalities are implemented through PowerShell 6.0+ scripts, given that PowerShell and the default .NET 4.7.2 runtime (which Powershell 6.0+ is built on top of) are present in WS2019 & WS2022, as documented here:

- [PowerShell Support Lifecycle](https://learn.microsoft.com/en-us/powershell/scripting/install/powershell-support-lifecycle?view=powershell-7.3#release-history)
- [.NET Framework versions and dependencies](https://learn.microsoft.com/en-us/dotnet/framework/migration-guide/versions-and-dependencies#net-framework-472)

All Handler commands relay on a single `common.ps1` script library, while keeping all the command scripts such enable/disable/install/update as one-liners, for better readability and maintainability.

### Versioning
Ref. docs: https://github.com/Azure/azure-vmextension-publishing/wiki/Extension-Handler-Publishing#about-extension-versioning

The VM Extension is versioned using the following format, `<MajorVersion.MinorVersion.PatchVersion.HotfixVersion>`, which nicely overlaps with the `<Major.Minor.Patch>` [Semantic Versioning](https://semver.org/) specification used in eBPF For Windows. We therefore leverage the last fourth digit for the VM Extension Handler updating only, so that it will be possible to update the handler itself, while maintaining the same eBPF version.

>**IMPORTANT**: the VM Extension platform only supports 2 digits for the version number, when installed from the client, so in practice, it will not be possible to control the deployment of the eBPF bits down to the *Patch* level, i.e., the VM-Agent will always pick the latest version of the VM Extension Handler for a given *<Major.Minor>* version, and will not be able to pick a specific "*<\*.\*.PatchVersion.HotfixVersion>*" version. This is a by-design constraint of the VM Extension platform, and it is not expected to be changed in the near future.

### Handler logic
Ref. docs: https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#236-summary

The VM Agent will call the Handler with the following commands, whenever the VM Extension is enabled, disabled, installed, updated, or uninstalled. From a theoretical point, it's worth noting that these commands are always pertaining to the VM Extension itself, and not to the eBPF runtime or eBPF programs that are installed by the VM Extension. We though use these commands to install, update, and uninstall the eBPF runtime and eBPF programs, conditionally to the logical connections between the VM Extension and the eBPF runtime and eBPF programs.

>**NOTE**: for each of the following operations, if the goal is to update the VM Extension only, then the eBPF Team will publish a new Handler with the same eBPF version number, but with a higher build number. The VM Agent will then call the Handler with the `Update` command, and the eBPF installer will recon if the version is the same of the one currently installed, and in that case won't perform any action. Therefore, the below logic will always refer to the cases in which eBPF is the target of the operation.

#### Enable VM Extension Handler
This operation will **start** the eBPF services, and create a `.status` file, and is actually implemented by the `Enable-eBPF-Handler` function.
##### Return codes
- 0: success, Non-0: failure.
- Writes status file: **Yes**.

#### Disable VM Extension Handler
This operation will **stop** the eBPF services, and create a `.status` file, and is actually implemented by the `Disable-eBPF-Handler` function.
##### Return codes
- 0: success, Non-0: failure.
- Writes status file: **No**

#### Install VM Extension Handler
This operation will install the eBPF runtime and eBPF programs, and will NOT create a `.status` file, since the VM Agent will subsequently call the Handler with the `Enable` command.

The install command is actually implemented by the `Install-eBPF-Handler` function, which will install the eBPF runtime and eBPF programs, if not already installed, or update them, if already installed.. If for any reason eBPF is installed in a different location from the default, it will maintain the same location, and will update the eBPF runtime and eBPF programs in that location.
##### Return codes
- 0: success, Non-0: failure.
- Writes status file: **No**.

#### Update VM Extension Handler
This operation will update the eBPF runtime and eBPF programs, and will NOT create a `.status` file, since the VM Agent will subsequently call the Handler with the `Enable` command.
The install command is actually implemented by the `Update-eBPF-Handler` function, which will install the eBPF runtime and eBPF programs, if not already installed, or update them, if already installed. If for any reason eBPF is installed in a different location from the default, it will maintain the same location, and will update the eBPF runtime and eBPF programs in that location.
##### Return codes
- 0: success, Non-0: failure.
- Writes status file: **No**.

#### Uninstall VM Extension Handler
This operation will uninstall the eBPF runtime and eBPF programs, and will create a `.status` file, and is actually implemented by the `Update-eBPF-Handler` function.

##### Return codes
- 0: success, Non-0: failure.
- Writes status file: **Yes**.

#### Reset VM Extension Handler
No implementation required for eBPF.

##### Return codes
- 0: success, Non-0: failure.
- Writes status file: **No**

## Publishing the VM Extension Handler

Official docs: https://github.com/Azure/azure-vmextension-publishing/wiki/Extension-Handler-Publishing

### Prerequisites

- Ask to be "`Azure Service Deploy Release Management Contributor`" of the Team's Azure Prod subscription, currently "`eBPF for Windows`", SubscriptionID: `78a9bec8-945c-4cc0-83bf-77c6d384d2ca`.
- Create a resource group named "`eBpfVmExtension`" in the Azure Prod subscription.
- Create as Azure Storage Account account in the Azure Prod subscription, named "`ebpfstorageaccount`", within the "`eBpfVmExtension`" resource group.
- Create an Azure Blob Container named "`ebpf-ext-container`" within the "`ebpfstorageaccount`" Storage Account.

### Creating the VM Extension Handler Package

1. Once you have the eBPF redistributable package to be released from the CI/CD pipeline, create the VM Extension ZIP file by executing the following PowerShell script from the `.azure` folder:

    ```PS
    PS> .\create-zip-package.ps1 -versionNumber <x.y.z.p> -ebpfBinPackagePath "<full path to the eBPF binaries root from the eBPF Redist package>" -zipDestinationFolder "<full path to the destination folder for the ZIP package file>"

    # Example: creating the package for eBPF v0.9.1, with the extension handler patch v1 for that eBPF version -> v0.9.1.1
    PS> .\create-zip-package.ps1 -versionNumber "0.9.1.1" -ebpfBinPackagePath "D:\work\_scratch\v0.9.1" -zipDestinationFolder "D:\work\_scratch"

    ```
    The resulting ZIP file will be named after the following format:
    
    ```bash
    <publisher>.<extension name>.<version>.zip # e.g.: Microsoft.eBpfForWindows.eBpfForWindows.0.9.1.1.zip
    ```

    where:

    - `<publisher>` is the publisher name, i.e. `Microsoft.eBpfForWindows`.
    - `<extension name>` is the extension name, i.e. `eBpfForWindows`.
    - `<version>` is the VM Extension version, conventionally matching its first 3 digits with the eBPF version, e.g. `0.9.1.1` (`<MajorVersion.MinorVersion.PatchVersion.HotfixVersion>`, which we overlap with the `<Major.Minor.Patch>` versioning for eBPF).
    
1. Upload the zip file to the Azure Storage Account container named "`ebpf-vm-extension-artifacts`" within the "`eBPF-vm-extension`" resource group.

### Registering the VM Extension

Registering the VM Extension is a **one-time operation**, since this will simply register the VM Extension's namespace and metadata to the platform, with no information regarding versioning or media.

From your SAW Machine, register the *`eBpfArmRegistrationTemplate.json`* ARM template using the following PowerShell commands:

```PS
# Make sure you install Az PowerShell v6.0.0
Install-Module az # Only needed once
Connect-AzAccount
Select-AzSubscription -SubscriptionId 78a9bec8-945c-4cc0-83bf-77c6d384d2ca

# CD to the path where the ARM template is located, and register the VM Extension within the created resource group:
New-AzResourceGroupDeployment -Name ExtensionPublishing -ResourceGroupName eBpfVmExtension -TemplateFile .\eBpfArmRegistrationTemplate.json -Verbose
```

### Publishing the VM Extension

Make sure to update the following variables in the *`eBpfArmPublishingTemplate.json`* ARM template with all the required information for the current version of the VM Extension, e.g.:

```json
"version": "0.9.1.1", // The version of the VM Extension
"mediaLink": "https://ebpfextstorageaccount.blob.core.windows.net/ebpf-ext-container/Microsoft.eBpfForWindows.eBpfForWindows.0.9.1.1.zip", // The URL of the ZIP file containing the VM Extension Handler
"regions": ["East US 2 EUAP", ...], // List of regions where the extension will be published
"isInternalExtension": "true/fase", // Whether the extension is internal or not. IMPORTANT!! This flag cannot be reverted once the extension has been made public!
``` 
> NOTE: Canary regions can be either "`East US 2 EUAP`" or "`Central US EUAP`".


From your SAW Machine, publish the *`eBpfArmPublishingTemplate.json`* ARM template using the using the following PowerShell commands:
    
```PS
# CD to the path where the ARM template is located, and publish the VM Extension within the created resource group:
New-AzResourceGroupDeployment -Name ExtensionPublishing -ResourceGroupName eBpfVmExtension -TemplateFile .\eBpfArmPublishingTemplate.json -Verbose
```

#### Verifying the Publishing status

When the extension is getting published, it can take a few hours sometimes in certain regions. Until the extension is replicated in all regions it will not be listed. But you can verify the regional status by using the following PowerShell commands. These commands must be executed within the context of the publisher's subscription (i.e. on the SAW machine):

```PS
$publisherName="Microsoft.eBpfForWindows"
$typeName="eBpfForWindows"
$version="0.9.1.1"
$resourceGroupName = "eBpfVmExtension"
$name = $publisherName + "." + $typeName + "/" + $version
(Get-AzResource -ResourceGroupName $resourceGroupName -Name $name -ExpandProperties).Properties.replicationStatus.summary | Sort-Object -Property "region" | Format-Table
```

>**NOTE**: once the publishing has succeeded, the blob on the storage account can be safely deleted, so that it will not be publicly accessible anymore. Another approach is to remove public access to the blob, so that it will not be publicly accessible anymore, which would allow keeping a history of published ZIP files.

## Testing the VM Extension Handler

#### Creating a Test-VM
##### Prerequisites

- Request to be "`owner`" of the Team's Azure Prod subscription, currently "`eBPF for Windows`", SubscriptionID: `78a9bec8-945c-4cc0-83bf-77c6d384d2ca`.
- Create the VM within the same resource group named "`eBpfVmExtension`", in which the storage account was created earlier.

Create a Test-VM for testing the VM Extension Handler from within the Team's Azure Production subscription. Due to the Production subscription's limitations, creating a VM from the Azure portal is denied, so it must be created it from PowerShell:

>Important: then VM **must** be created within the ***same region in which the VM Extension Handler has been registered an published***, otherwise the VM Extension will not be found.

```PS
# Setting up the environment variables, fo WS2019 Datacenter Gen2
$credential = Get-Credential
$resourceGroupName = 'eBpfVmExtension'
$location = 'eastus2euap'
$vmName = 'eBpfVmM-EastEUAP'
$vmSize = 'Standard_B2als_v2'
$image = 'MicrosoftWindowsServer:WindowsServer:2019-datacenter-gensecond:latest'

New-AzVM -Name $vmName -Credential $credential -ResourceGroupName $resourceGroupName -Location $location -Size $vmSize -Image $image
```

#### Installing the VM Extension on the Test-VM

Ref docs: https://learn.microsoft.com/en-us/powershell/module/az.compute/set-azvmextension?view=azps-10.3.0

```PS
# Example: installing the eBPF VM Extension on a Test-VM named "eBpfVm-EastEUAP", located in the "eastus2euap" Canary region.

Connect-AzAccount
Select-AzSubscription -SubscriptionId 78a9bec8-945c-4cc0-83bf-77c6d384d2ca


# Below are the VM Extension parameters
$publisherName="Microsoft.eBpfForWindows"
$typeName="eBpfForWindows"
$version="0.9" # NOTE: the VM Extension platform only supports 2 digits for the version number, when installed from the client, so we need to truncate the eBPF version number to 2 digits!

# Below are the Test-VM parameters
$vmExtName = "eBpfForWindows" # NOTE: this is the desired name for the extension on the Test-VM, not the VM Extension name!
$vmResourceGroup = "eBpfVmExtension"
$vmLocation = "eastus2euap"
$vmName = "eBpfVm-EastEUAP"
$extSettings = @{"temp" = "";}; # NOTE! A dummy settings file is necessary for the VM Extension handler to retrieve a SequenceNumber and generate status files, even if the VM Extension does not support user-settings! This is "by design".

Set-AzVMExtension -Publisher $publisherName -ExtensionType $typeName -Name $vmExtName -TypeHandlerVersion $version -Location $vmLocation -ResourceGroupName $vmResourceGroup -VMName $vmName -Settings $extSettings
```

The logs from the VM-Agent will be located under `C:\WindowsAzure\Plugins\<full VM Extension namespace>\<version>\`:

- "`CommandExecution.log`": contains the logs from the "`Windows Azure Guest Agent`" Windows service, whish handles all VM Extension Handlers command execution.
- "`ebpf_handler.log`": contains the logs of the eBPF VM Extension Handler execution.


#### Removing the VM Extension from the Test-VM

Ref.docs: https://learn.microsoft.com/en-us/powershell/module/az.compute/remove-azvmextension?view=azps-10.3.0

```PS
$vmExtName = "eBpfForWindows" # NOTE: this is the given name of the extension on the Test-VM, not the VM Extension name!
$vmResourceGroup = "eBpfVmExtension"
$vmName = "eBpfVm-EastEUAP"
Remove-AzVMExtension -ResourceGroupName $vmResourceGroup -Name $vmExtName -VMName $vmName
```

## UNDEFINED TOPICS FROM THE DOCS

### 1.0 Partner Guide Overview
[1.3 AggregateStatus Architecture Overview](https://github.com/Azure/azure-vmextension-publishing/wiki/1.0-Partner-Guide-Overview#13aggregatestatus-architecture-overview): `images/extensionarchitecture.png` link is broken.

### 2.3.4 Update Command (empty - WIP)
https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#234-update-command

For example, does the `Update` call `Enable`, like the `Install`? Looks not clarified also in [2.2.3 Update a handler to different version](https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#223update-a-handler-to-different-version)

### 2.3.6 Summary
https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#236-summary

- The "Reserved Exit Code" & "Recommended Exit Code" paragraphs are WIP -> is the publisher free to use any?
- In the "`VM Agent Contracts Expectations for Handler Commands Window VM"`, the `Disable` & `Reset` commands have a `"Yes?"`, which does not uniquely define the column "Extension writes status file".
    > NOTE: A follow up with the VM Extension Team confirmed **No**.
- Although the [2.2.1 Add a new handler on the VM (Install and Enable)](https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#221-add-a-new-handler-on-the-vm-install-and-enable) specifies that the `Enable` command will be called and required to generate a Status file, in the summary it is defined as "NA", and [here](https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#231-install-command) is undocumented.
