# eBPF for Windows Azure VM Extension for IaaS - The extension is currently in preview.

Ref. docs: https://github.com/Azure/azure-vmextension-publishing/wiki

This project implements the eBPF for Windows Azure VM Extension for IaaS. This extension allows you to deploy eBPF programs to Azure VMs running Windows.
The extension also relies on the Azure VM Agent to execute a number of Powershell scripts to install the eBPF runtime and default eBPF programs.

The minimal requirements for a VM Extension are:

- A `HandlerManifest.json` file, always located in the root, that defines how the VM Extension Handler functionalities are performed.
- Processing the `HandlerEnvironment.json` file, always located in the root, that defines the environment variables that are passed to the VM Extension Handler from the VM Agent. This file is generated by the VM Agent, it is not meant to be modified by the user, and must be read by the VM Extension Handler.
- Processing the configuration file (located in the given "configuration" folder, and which has a `<extension name>.<ConfigSequenceNumber>.settings` extension!) that contains the configuration settings for the extension. Its file name is a so called `ConfigSequenceNumber`, which must be used to generate corresponding `<extension name>.<ConfigSequenceNumber>.status` files. The configuration file is passed by the VM Agent, it is not meant to be modified by the user, and must be read by the VM Extension Handler, if user-settings are supported.

    >**NOTE**: The the `ConfigSequenceNumber` is to be determined from the name of the *latest created* `*.*.settings` file, within the environment's `configFolder`, this because it is not granted that the latest `ConfigSequenceNumber` is actually the latest file to be considered!
- Scripts for installing, enabling, disabling uninstalling, and updating the extension.
- Capability of parsing and generating JSON files (i.e. for status reporting, etc.).

A VM extension for eBPF could be implemented with different methods, for implementing the above scripts requirements, given that PowerShell and the default .NET 4.7.2 runtime (which Powershell 6.0+ is built on top of) that are listed here:

- [PowerShell Support Lifecycle](https://learn.microsoft.com/en-us/powershell/scripting/install/powershell-support-lifecycle?view=powershell-7.3#release-history)
- [.NET Framework versions and dependencies](https://learn.microsoft.com/en-us/dotnet/framework/migration-guide/versions-and-dependencies#net-framework-472)


## Versioning

The VM Extension is versioned using the following format, `<Major>.<Minor>.<Patch>.<Build>`, which is the same format used by the [Semantic Versioning](https://semver.org/) specification on eBPF, while reserving the last digit for the VM Extension Handler updating only.

## Handler implementation

The VM Extension Handler functionalities are implemented with PowerShell 6.0+ scripts.
All Handler commands relay on a single `common.ps1` script library, while keeping all the command scripts such enable/disable/install/update as one-liners. Uninstall has a few more lines of code, but it is still essentially a two-liner.


## Handler logic
Ref.: https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#236-summary


The VM Agent will call the Handler with the following commands, whenever the VM Extension is enabled, disabled, installed, updated, or uninstalled. From a theoretical point, it's worth noting that these commands are always pertaining to the VM Extension itself, and not to the eBPF runtime or eBPF programs that are installed by the VM Extension. We though use these commands to install, update, and uninstall the eBPF runtime and eBPF programs, conditionally to the logical connections between the VM Extension and the eBPF runtime and eBPF programs.

>**NOTE**: for each of the following operations, if the goal is to update the VM Extension only, then the eBPF Team will publish a new Handler with the same eBPF version number, but with a higher build number. The VM Agent will then call the Handler with the `Update` command, and the eBPF installer will recon if the version is the same of the one currently installed, and in that case won't perform any action. Therefore, the below logic will always refer to the cases in which eBPF is the target of the operation.

### Enable VM Extension Handler
This operation will stop the eBPF services, and create a `*.*.status` file, with the `SequenceNumber` determined from the name of the *latest created* `*.*.settings` file, within the environment's `configFolder`.
#### Return codes
- 0: success, Non-0: failure
- Writes status file: **NA**

### Disable VM Extension Handler
This operation will start the eBPF services, and create a `*.*.status` file, with the `SequenceNumber` determined from the name of the *latest created* `*.*.settings` file, within the environment's `configFolder`.
#### Return codes
- 0: success, Non-0: failure
- Writes status file: **"Yes?" NOT DEFINED IN DOCS**

### Install VM Extension Handler
This operation will install the eBPF runtime and eBPF programs, and will NOT create a `*.*.status` file, since the VM Agent will subsequently call the Handler with the `Enable` command.

The install command is actually implemented by the `Install-eBPF-Handler` command, which will install the eBPF runtime and eBPF programs, if not already installed, or update them, if already installed.
#### Return codes
- 0: success, Non-0: failure
- Writes status file: **No**

### Update VM Extension Handler
>**NOTE**: this command is currently undocumented: https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#234-update-command

This operation will update the eBPF runtime and eBPF programs, and will NOT create a `*.*.status` file, since the VM Agent will subsequently call the Handler with the `Enable` command.
The install command is actually implemented by the `Update-eBPF-Handler` command, which will install the eBPF runtime and eBPF programs, if not already installed, or update them, if already installed.
#### Return codes
- 0: success, Non-0: failure
- Writes status file: **No**

### Uninstall VM Extension Handler
This operation will uninstall the eBPF runtime and eBPF programs, and will create a `*.*.status` file, with the `SequenceNumber` determined from the name of the *latest created* `*.*.settings` file, within the environment's `configFolder`.

#### Return codes
- 0: success, Non-0: failure
- Writes status file: **Yes**

### Reset VM Extension Handler
NOT IMPLEMENTED

#### Return codes
- 0: success, Non-0: failure
- Writes status file: **"Yes?" NOT DEFINED IN DOCS**

## UNDEFINED TOPICS FROM THE DOCS

### 1.0 Partner Guide Overview
[1.3 AggregateStatus Architecture Overview](https://github.com/Azure/azure-vmextension-publishing/wiki/1.0-Partner-Guide-Overview#13aggregatestatus-architecture-overview): `images/extensionarchitecture.png` link is broken.

### 2.3.4 Update Command (empty - WIP)
https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#234-update-command

For example, does the `Update` call `Enable`, like the `Install`? Looks not clarified also in [2.2.3 Update a handler to different version](https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#223update-a-handler-to-different-version)

### 2.3.6 Summary
https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#236-summary

- The "Reserved Exit Code" & "Recommended Exit Code" paragraphs are WIP -> is the publisher free to use any?
- In the "`VM Agent Contracts Expectations for Handler Commands Window VM"`, the `Disable` & `Reset` commands have a `"Yes?"`, which does not uniquely define the column "Extension writes status file".
- Although the [2.2.1 Add a new handler on the VM (Install and Enable)](https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#221-add-a-new-handler-on-the-vm-install-and-enable) specifies that the `Enable` command will be called and required to generate a Status file, in the summary it is defined as "NA", and [here](https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#231-install-command) is undocumented.



