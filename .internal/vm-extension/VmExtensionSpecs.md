# eBPF for Windows Azure VM Extension for IaaS

Ref. docs: https://github.com/Azure/azure-vmextension-publishing/wiki

This project implements the eBPF for Windows Azure VM Extension for IaaS. This extension allows you to deploy eBPF programs to Azure VMs running Windows.
The extension also relies on the Azure VM Agent to execute a number of Powershell scripts to install the eBPF runtime and default eBPF programs.

The minimal requirements for a VM Extension are:

- A `HandlerManifest.json` file, always located in the root, that defines how the VM Extension Handler functionalities are performed.
- Processing the `HandlerEnvironment.json` file, always located in the root, that defines the environment variables that are passed to the VM Extension Handler from the VM Agent. This file is generated by the VM Agent, it is not meant to be modified by the user, and must be read by the VM Extension Handler.
- Processing the configuration file (located in the given "configuration" folder, and which has a `<extension name>.<ConfigSequenceNumber>.settings` extension!) that contains the configuration settings for the extension. Its file name is a so called `ConfigSequenceNumber`, which must be used to generate corresponding `<extension name>.<ConfigSequenceNumber>.status` files. The configuration file is passed by the VM Agent, it is not meant to be modified by the user, and must be read by the VM Extension Handler, if user-settings are supported.

    >**NOTE**: The the `ConfigSequenceNumber` is to be determined from the name of the *latest modified* `*.*.settings` file, within the environment's `configFolder`, this because it is not granted that the latest `ConfigSequenceNumber` is actually the latest file to be considered!
- Scripts for installing, enabling, disabling uninstalling, and updating the extension.
- Capability of parsing and generating JSON files (i.e. for status reporting, etc.).

A VM extension for eBPF could be implemented with different methods, for implementing the above scripts requirements, given that PowerShell and the default .NET 4.7.2 runtime (which Powershell 6.0+ is built on top of) that are listed here:

- [PowerShell Support Lifecycle](https://learn.microsoft.com/en-us/powershell/scripting/install/powershell-support-lifecycle?view=powershell-7.3#release-history)
- [.NET Framework versions and dependencies](https://learn.microsoft.com/en-us/dotnet/framework/migration-guide/versions-and-dependencies#net-framework-472)


## VM Extension Handler implementation

The VM Extension Handler functionalities are implemented with PowerShell 6.0+ scripts.
All Handler commands relay on a single `common.ps1` script library, while keeping all the command scripts such enable/disable/install/update as one-liners. Uninstall has a few more lines of code, but it is still essentially a two-liner.

### Versioning

The VM Extension is versioned using the following format, `<Major>.<Minor>.<Patch>.<Build>`, which is the same format used by the [Semantic Versioning](https://semver.org/) specification on eBPF. We therefore leverage the last fourth digit for the VM Extension Handler updating only, so that it will be possible to update the handler itself, while maintaining the same eBPF version.

### Handler logic
Ref.: https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#236-summary


The VM Agent will call the Handler with the following commands, whenever the VM Extension is enabled, disabled, installed, updated, or uninstalled. From a theoretical point, it's worth noting that these commands are always pertaining to the VM Extension itself, and not to the eBPF runtime or eBPF programs that are installed by the VM Extension. We though use these commands to install, update, and uninstall the eBPF runtime and eBPF programs, conditionally to the logical connections between the VM Extension and the eBPF runtime and eBPF programs.

>**NOTE**: for each of the following operations, if the goal is to update the VM Extension only, then the eBPF Team will publish a new Handler with the same eBPF version number, but with a higher build number. The VM Agent will then call the Handler with the `Update` command, and the eBPF installer will recon if the version is the same of the one currently installed, and in that case won't perform any action. Therefore, the below logic will always refer to the cases in which eBPF is the target of the operation.

#### Enable VM Extension Handler
This operation will stop the eBPF services, and create a `*.*.status` file, with the `SequenceNumber` determined from the name of the *latest created* `*.*.settings` file, within the environment's `configFolder`.
##### Return codes
- 0: success, Non-0: failure
- Writes status file: **NA**

#### Disable VM Extension Handler
This operation will start the eBPF services, and create a `*.*.status` file, with the `SequenceNumber` determined from the name of the *latest created* `*.*.settings` file, within the environment's `configFolder`.
##### Return codes
- 0: success, Non-0: failure
- Writes status file: **"Yes?" NOT DEFINED IN DOCS**

#### Install VM Extension Handler
This operation will install the eBPF runtime and eBPF programs, and will NOT create a `*.*.status` file, since the VM Agent will subsequently call the Handler with the `Enable` command.

The install command is actually implemented by the `Install-eBPF-Handler` command, which will install the eBPF runtime and eBPF programs, if not already installed, or update them, if already installed.
##### Return codes
- 0: success, Non-0: failure
- Writes status file: **No**

#### Update VM Extension Handler
>**NOTE**: this command is currently undocumented: https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#234-update-command

This operation will update the eBPF runtime and eBPF programs, and will NOT create a `*.*.status` file, since the VM Agent will subsequently call the Handler with the `Enable` command.
The install command is actually implemented by the `Update-eBPF-Handler` command, which will install the eBPF runtime and eBPF programs, if not already installed, or update them, if already installed.
##### Return codes
- 0: success, Non-0: failure
- Writes status file: **No**

#### Uninstall VM Extension Handler
This operation will uninstall the eBPF runtime and eBPF programs, and will create a `*.*.status` file, with the `SequenceNumber` determined from the name of the *latest created* `*.*.settings` file, within the environment's `configFolder`.

##### Return codes
- 0: success, Non-0: failure
- Writes status file: **Yes**

#### Reset VM Extension Handler
NOT IMPLEMENTED

##### Return codes
- 0: success, Non-0: failure
- Writes status file: **"Yes?" NOT DEFINED IN DOCS**

## VM Extension Handler Publishing

Official docs: https://github.com/Azure/azure-vmextension-publishing/wiki/Extension-Handler-Publishing

### Creating the VM Extension Handler Package

1. Once you have the eBPF redistributable package, create the VM Extension ZIP file by executing the following PowerShell script from the `.azure` folder:

    

    ```PS
    PS> .\create-zip-package.ps1 -versionNumber <x.y.z.p> -ebpfBinPackagePath "<full path to the eBPF binaries root from the eBPF Redist package>" -zipDestinationFolder "<full path to the destination folder for the ZIP package file>"

    # Example:
    PS> .\create-zip-package.ps1 -versionNumber "0.10.0.1" -ebpfBinPackagePath "D:\work\_scratch\v0.9.1" -zipDestinationFolder "D:\work\_scratch"

    ```
    The resulting ZIP file will be named after the following format:
    
    ```bash
    <publisher>.<extension name>.<version>.zip
    ```

    where:

    - `<publisher>` is the publisher name, i.e. `Microsoft.eBPF`

    - `<extension name>` is the extension name, i.e. `eBpfForWindows`

    - `<version>` is the extension version, e.g. `0.10.0.1`
    
1. Upload the zip file to the Azure Storage Account container named "`ebpf-vm-extension-artifacts`" within the "`eBPF-vm-extension`" resource group.

### Registering the VM Extension
Deploy the ARM template using the PowerShell cmdlet as follows (**this is a on-time operation**):

```PS
PS> New-AzResourceGroup -Name eBpfForWindows -Location SouthCentralUS
PS> New-AzResourceGroupDeployment -Name ExtensionPublishing -ResourceGroupName eBpfForWindows -TemplateFile .\.azure\eBpfArmRegisteringTemplate.json -Verbose
```

### Publishing the VM Extension (Canary is "Central US EUAP")

Deploy the ARM template using the PowerShell cmdlet as follows:
    
```PS
PS> New-AzResourceGroupDeployment -Name ExtensionPublishing -ResourceGroupName eBpfForWindows -TemplateFile .\.azure\eBpfArmPublishingTemplate.json -Verbose
```

### Verifying Publishing Status

When the extension is getting published, it can take a few hours sometimes in certain regions. Until the extension is replicated in all regions it will not be listed. But you can verify the regional status by using the following PowerShell commands. These commands must be executed within the context of the publisher's subscription.

```PS
$publisherName="Microsoft.eBPF"
$typeName="eBpfForWindows"
$version="0.9.1.1"
$resourceGroupName = "eBpfForWindows"
$name = $publisherName + "." + $typeName + "/" + $version
(Get-AzResource -ResourceGroupName $resourceGroupName -Name $name -ExpandProperties).Properties.replicationStatus.summary | Sort-Object -Property "region" | Format-Table
```

### Deploying the VM Extension within a VM

Important: then VM **must** be created within the same subscription of the publisher, otherwise the VM Extension will not be found.

#### Creating the VM

Due to the Prod subscription limitations, creating it from the Azure portal is not possible, so we need to create it from PowerShell:

```PS
$credential = Get-Credential
$resourceGroupName = "eBpfVmExtension"
$location = "Central US EUAP"
$vmName = "eBpfTestVMCanary"
$imagePublisher = "MicrosoftWindowsServer"
$imageOffer = "WindowsServer"
#$imageSku = "2019-Datacenter"
$imageSku = "2019-datacenter-gensecond"
$imageVersion = "latest"
$vmSize = "Standard_B2als_v2"

$imageReference = "/subscriptions/78a9bec8-945c-4cc0-83bf-77c6d384d2ca/resourceGroups/$resourceGroupName/providers/Microsoft.Compute/galleries/$imageOffer/images/$imageSku/versions/$imageVersion"
New-AzVM `
  -Name $vmName `
  -Credential $credential `
  -ResourceGroupName $resourceGroupName `
  -Location $location `
  -Size $vmSize `
  -ImageReferenceId $imageReference

$imageReference = Get-AzVMImage -Location $location -PublisherName $imagePublisher -Offer $imageOffer -Skus $imageSku -Version $imageVersion
New-AzVM `
  -Name $vmName `
  -Credential $credential `
  -ResourceGroupName $resourceGroupName `
  -Location $location `
  -Size $vmSize `
  -Image $imageReference[0].Id
```

#### Installing the VM Extension

```PS
# https://learn.microsoft.com/en-us/powershell/module/az.compute/set-azvmextension?view=azps-10.3.0
$publisherName="Microsoft.eBPF"
$typeName="eBpfForWindows"
$version="0.9.1.1"
$extName = "eBpfForWindows"
$vmLocation = "SouthCentralUS"
$resourceGroup = "eBpfVmExtension"
$vm = "eBpfVmTest"

Set-AzVMExtension -Publisher $publisherName -ExtensionType $typeName -Name $extName -TypeHandlerVersion $version -Location $vmLocation -ResourceGroupName $resourceGroup -VMName $vm
```

While CollectGuestLogs.exe is always under `C:\WindowsAzure``, different guest agent versions will have it in different subfolders, so the PowerShell command below will find it in whichever `C:\WindowsAzure`` subfolder it resides, and then run it.
Run the following command from elevated PowerShell:

```PS
invoke-expression (get-childitem -Path c:\windowsazure -Filter CollectGuestLogs.exe -Recurse | sort LastAccessTime -desc | select -first 1).FullName
 
``` 

## UNDEFINED TOPICS FROM THE DOCS

### 1.0 Partner Guide Overview
[1.3 AggregateStatus Architecture Overview](https://github.com/Azure/azure-vmextension-publishing/wiki/1.0-Partner-Guide-Overview#13aggregatestatus-architecture-overview): `images/extensionarchitecture.png` link is broken.

### 2.3.4 Update Command (empty - WIP)
https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#234-update-command

For example, does the `Update` call `Enable`, like the `Install`? Looks not clarified also in [2.2.3 Update a handler to different version](https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#223update-a-handler-to-different-version)

### 2.3.6 Summary
https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#236-summary

- The "Reserved Exit Code" & "Recommended Exit Code" paragraphs are WIP -> is the publisher free to use any?
- In the "`VM Agent Contracts Expectations for Handler Commands Window VM"`, the `Disable` & `Reset` commands have a `"Yes?"`, which does not uniquely define the column "Extension writes status file".
- Although the [2.2.1 Add a new handler on the VM (Install and Enable)](https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#221-add-a-new-handler-on-the-vm-install-and-enable) specifies that the `Enable` command will be called and required to generate a Status file, in the summary it is defined as "NA", and [here](https://github.com/Azure/azure-vmextension-publishing/wiki/2.0-Partner-Guide-Handler-Design-Details#231-install-command) is undocumented.



